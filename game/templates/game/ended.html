{% extends 'game/includes/base.html' %}
{% load role_extras %}
{% block head_title %}게임 종료{% endblock %}
{% block page_title %}게임 종료{% endblock %}

{% block content %}
    <div class="ended-container">
        <!-- 게임 정보 카드 -->
        <div class="game-info-card">
            <div class="info-header">
                <div class="info-icon">🏰</div>
                <h3 class="info-title">게임 정보</h3>
            </div>
            
            <div class="info-content">
                <div class="info-item">
                    <span class="info-label">세션 ID</span>
                    <span class="info-value session-id">{{ game_session.session_id }}</span>
                </div>
                

                
                <div class="info-item">
                    <span class="info-label">현재 플레이어</span>
                    <span class="info-value player-name">{{ player_nickname|default:"알 수 없음" }}</span>
                </div>
                
                {% if player_nickname %}
                <div class="info-item">
                    <span class="info-label">나의 역할</span>
                    <div class="my-role-info">
                        {% for player_obj in players_in_session %}
                            {% if player_obj.nickname == player_nickname %}
                                {% if player_obj.roles and player_obj.roles|length > 1 %}
                                    <!-- 다중 역할 -->
                                    {% for role in player_obj.roles %}
                                        <span class="role-badge role-{{ role }}">{{ role|role_display }}</span>
                                    {% endfor %}
                                {% else %}
                                    <!-- 단일 역할 -->
                                    <span class="role-badge role-{{ player_obj.primary_role }}">{{ player_obj.primary_role|role_display }}</span>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- 게임 종료 메시지 카드 -->
        <div class="game-end-message-card">
            <div class="end-message-header">
                <div class="end-message-icon">🎭</div>
                <h3 class="end-message-title">게임 결과</h3>
            </div>
            
            <div class="end-message-content">
                <p class="end-message-text">{{ message }}</p>
            </div>
        </div>

        <!-- 역할 공개 카드 -->
        {% if game_session.is_started %}
        <div class="roles-reveal-card">
            <div class="roles-header">
                <div class="roles-icon">🎪</div>
                <h3 class="roles-title">역할 공개</h3>
                <div class="roles-count">{{ players_in_session|length }}명</div>
            </div>
            
            <div class="roles-content">
                <div class="roles-grid">
                    {% for player in players_in_session %}
                    <div class="role-reveal-item {% if player.faction == 'evil' %}evil-side{% else %}good-side{% endif %}">
                        <div class="player-role-avatar">
                            {% if player.role_images and player.role_images|length > 1 %}
                                <!-- 다중 역할 이미지 -->
                                <div class="multi-role-images">
                                    {% for image in player.role_images %}
                                        <img src="{{ image }}" alt="역할 {{ forloop.counter }}" class="role-reveal-image-small">
                                    {% endfor %}
                                </div>
                            {% else %}
                                <!-- 단일 역할 이미지 -->
                                <img src="{% if player.role_images.0 %}{{ player.role_images.0 }}{% else %}/static/default_role.png{% endif %}" alt="{{ player.primary_role }}" class="role-reveal-image">
                            {% endif %}
                        </div>
                        
                        <div class="player-role-info">
                            <div class="player-role-nickname">{{ player.nickname }}</div>
                            <div class="player-role-name">
                                {% if player.roles and player.roles|length > 1 %}
                                    <!-- 다중 역할 -->
                                    <div class="multi-roles">
                                        {% for role in player.roles %}
                                            <span class="role-badge role-{{ role }}">{{ role|role_display }}</span>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <!-- 단일 역할 -->
                                    <span class="role-badge role-{{ player.primary_role }}">{{ player.primary_role|role_display }}</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if player.nickname == game_session.host_nickname %}
                            <div class="player-host-badge-small">👑</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- 새 게임 추천 카드 -->
        <div class="new-game-card">
            <div class="new-game-content">
                <div class="new-game-icon">🎮</div>
                <h3 class="new-game-title">새로운 게임을 시작해보세요!</h3>
                <p class="new-game-description">다시 한 번 아발론의 세계로 떠나보시겠어요?</p>
                <a href="{% url 'home' %}" class="new-game-btn">
                    <span class="btn-icon">🚀</span>
                    <span class="btn-text">새 게임 만들기</span>
                </a>
            </div>
        </div>
        {% endif %}
    </div>
{% endblock %}