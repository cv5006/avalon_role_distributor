{% extends 'game/includes/base.html' %}
{% block head_title %}게임 로비{% endblock %}
{% block page_title %}게임 로비{% endblock %}


{% block content %} 
    {% include 'game/includes/info.html' with player_nickname=player_nickname game_session=game_session %}

    <table id="player-list">
        <thead><b>현재 참여 중인 플레이어</b></thead>
        <tbody><tr><td colspan="2">플레이어 리스트 불러오는 중...</td></tr></tbody>
    </table >

    <label for="session-link">🔗:</label>
    <input type="text" id="session-link" value="{{ session_link }}" readonly style="width: 100px;">
    <button onclick="copySessionLink()">복사</button>
    <p id="copy-message" style="color: green;"></p>

    {% if player_nickname == game_session.host_nickname %}
        <form method="post" action="{% url 'start_game' game_session.session_id %}">
            {% csrf_token %}
            <input type="hidden" name="nickname" value="{{ player_nickname }}">
            <input type="hidden" name="pin" value="{{ player_pin }}">
            <button type="submit" class="start-game-button" onclick="return confirm('정말로 게임을 시작하시겠습니까?');">게임 시작</button>
        </form>
    {% endif %}

{% endblock %}


{% block extra_body %}
    <!-- 게임 상태 업데이트 -->
    <meta name="csrf-token" content="{{ csrf_token }}">
    <script>
    let lastHash = null;
    const playerNickname = "{{ player_nickname }}";
    const playerPin = "{{ player_pin }}";
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    function updatePlayerList() {
        const url = new URL("{% url 'get_state' game_session.session_id %}", window.location.origin);
        if (lastHash) {
            url.searchParams.append('hash', lastHash)
        };

        fetch(url)
            .then(response => {
                if (response.status === 204) { 
                    return; // 변경 없음, 아무것도 하지 않음
                }
                return response.json();
            })
            .then(data => {
                if (!data || !data.players) {
                    return;
                }

                if (data.is_active === false) {
                    window.location.href = "{% url 'ended' game_session.session_id %}";
                    return;
                }

                if (data.is_started === true) {
                    window.location.href = "{% url 'role' game_session.session_id %}?nickname=" + playerNickname + "&pin=" + playerPin;
                    return;
                }
                
                const tableBody = document.getElementById("player-list");
                tableBody.innerHTML = '';

                data.players.forEach(function(nickname) {
                    let kickBtn = '';
                    if (playerNickname === data.host_nickname && nickname !== playerNickname) {
                        kickBtn = `
                            <form method="post" action="{% url 'kick_player' game_session.session_id %}">
                                <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                                <input type="hidden" name="target_nickname" value="${nickname}">
                                <input type="hidden" name="nickname" value="${playerNickname}">
                                <input type="hidden" name="pin" value="${playerPin}">
                                <button type="submit">❌</button>
                            </form>
                        `;
                    }
                    const rowContent = `<td>${kickBtn}</td><td>${nickname}</td>`;
                    const row = document.createElement("tr");
                    row.innerHTML = rowContent;
                    tableBody.appendChild(row);
                });
                lastHash = data.hash;
            })
            .catch(err => console.error("플레이어 목록 갱신 실패:", err));
    }

    setInterval(updatePlayerList, 1000); // ms
    </script>

    <!-- 링크 복사 -->
    <script>
    function copySessionLink() {
        const input = document.getElementById("session-link");
        input.select();
        input.setSelectionRange(0, 99999); // 모바일 대응

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                document.getElementById("copy-message").textContent = "클립보드에 복사되었습니다!";
            } else {
                document.getElementById("copy-message").textContent = "복사에 실패했습니다.";
            }
        } catch (err) {
            document.getElementById("copy-message").textContent = "이 브라우저는 복사를 지원하지 않습니다.";
        }

        setTimeout(() => {
            document.getElementById("copy-message").textContent = "";
        }, 2000);
    }
    </script>
{% endblock %}