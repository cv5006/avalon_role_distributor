{% extends 'game/includes/base.html' %}
{% block head_title %}게임 로비{% endblock %}
{% block page_title %}게임 로비{% endblock %}

{% block content %} 
    <div class="lobby-container">
        <!-- 게임 정보 카드 -->
        <div class="game-info-card">
            <div class="info-header">
                <div class="info-icon">🏰</div>
                <h3 class="info-title">게임 정보</h3>
            </div>
            
            <div class="info-content">
                <div class="info-item">
                    <span class="info-label">세션 ID</span>
                    <span class="info-value session-id">{{ game_session.session_id }}</span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">게임 옵션</span>
                    <div class="info-options">
                        {% if game_session.option1 and game_session.option2 %}
                                                         <span class="option-badge percival">🛡️ 퍼시벌</span>
                             <span class="option-badge morgana">🦹‍♀️ 모르가나</span>
                         {% elif game_session.option1 %}
                             <span class="option-badge percival">🛡️ 퍼시벌</span>
                         {% elif game_session.option2 %}
                             <span class="option-badge morgana">🦹‍♀️ 모르가나</span>
                        {% else %}
                            <span class="option-badge none">🎯 기본 게임</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="info-item">
                    <span class="info-label">현재 플레이어</span>
                    <span class="info-value player-name">{{ player_nickname }}</span>
                </div>
            </div>
        </div>

        <!-- 플레이어 목록 카드 -->
        <div class="players-card">
            <div class="players-header">
                <div class="players-icon">👥</div>
                <h3 class="players-title">참여 중인 플레이어</h3>
                <div class="players-count" id="players-count">0명</div>
            </div>
            
            <div class="players-content">
                <div id="player-list" class="player-list">
                    <div class="loading-placeholder">
                        <div class="loading-spinner"></div>
                        <span>플레이어 목록 불러오는 중...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 세션 링크 공유 카드 -->
        <div class="share-card">
            <div class="share-header">
                <div class="share-icon">🔗</div>
                <h3 class="share-title">친구 초대하기</h3>
            </div>
            
            <div class="share-content">
                <div class="link-input-group">
                    <input type="text" id="session-link" value="{{ session_link }}" readonly class="share-input">
                    <button onclick="copySessionLink()" class="copy-btn">
                        <span class="copy-btn-icon">📋</span>
                        <span class="copy-btn-text">복사</span>
                    </button>
                </div>
                <div id="copy-message" class="copy-message"></div>
            </div>
        </div>

        <!-- 게임 시작 카드 (호스트만 보임) -->
        {% if player_nickname == game_session.host_nickname %}
        <div class="host-actions-card">
            <div class="host-header">
                <div class="host-icon">👑</div>
                <h3 class="host-title">게임 시작</h3>
                <div class="host-badge">호스트</div>
            </div>
            
            <div class="host-content">
                <p class="start-description">모든 플레이어가 준비되면 게임을 시작하세요!</p>
                <form method="post" action="{% url 'start_game' game_session.session_id %}">
                    {% csrf_token %}
                    <input type="hidden" name="nickname" value="{{ player_nickname }}">
                    <input type="hidden" name="pin" value="{{ player_pin }}">
                    <button type="submit" class="start-game-btn" onclick="return confirm('정말로 게임을 시작하시겠습니까?');">
                        <span class="btn-icon">🚀</span>
                        <span class="btn-text">게임 시작</span>
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- 대기 중 메시지 (호스트가 아닌 경우) -->
        {% if player_nickname != game_session.host_nickname %}
        <div class="waiting-card">
            <div class="waiting-content">
                <div class="waiting-icon">⏳</div>
                <h3 class="waiting-title">게임 시작을 기다리는 중...</h3>
                <p class="waiting-description">호스트가 게임을 시작할 때까지 기다려주세요</p>
            </div>
        </div>
        {% endif %}
    </div>
{% endblock %}

{% block extra_body %}
    <!-- 게임 상태 업데이트 -->
    <meta name="csrf-token" content="{{ csrf_token }}">
    <script>
    let lastHash = null;
    const playerNickname = "{{ player_nickname }}";
    const playerPin = "{{ player_pin }}";
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    
    function updatePlayerList() {
        const url = new URL("{% url 'get_state' game_session.session_id %}", window.location.origin);
        if (lastHash) {
            url.searchParams.append('hash', lastHash)
        };

        fetch(url)
            .then(response => {
                if (response.status === 204) { 
                    return; // 변경 없음, 아무것도 하지 않음
                }
                return response.json();
            })
            .then(data => {
                if (!data || !data.players) {
                    return;
                }

                if (data.is_active === false) {
                    window.location.href = "{% url 'ended' game_session.session_id %}";
                    return;
                }

                if (data.is_started === true) {
                    window.location.href = "{% url 'role' game_session.session_id %}?nickname=" + playerNickname + "&pin=" + playerPin;
                    return;
                }
                
                const playerListContainer = document.getElementById("player-list");
                const playersCount = document.getElementById("players-count");
                
                // 플레이어 수 업데이트
                playersCount.textContent = data.players.length + '명';
                
                // 플레이어 목록 초기화
                playerListContainer.innerHTML = '';

                data.players.forEach(function(nickname) {
                    const playerItem = document.createElement("div");
                    playerItem.className = "player-item";
                    
                    const isHost = nickname === data.host_nickname;
                    const canKick = playerNickname === data.host_nickname && nickname !== playerNickname;
                    
                    let kickButton = '';
                    if (canKick) {
                        kickButton = `
                            <form method="post" action="{% url 'kick_player' game_session.session_id %}" class="kick-form">
                                <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                                <input type="hidden" name="target_nickname" value="${nickname}">
                                <input type="hidden" name="nickname" value="${playerNickname}">
                                <input type="hidden" name="pin" value="${playerPin}">
                                <button type="submit" class="kick-btn" title="플레이어 추방">
                                    <span class="kick-icon">❌</span>
                                </button>
                            </form>
                        `;
                    }
                    
                    const hostBadge = isHost ? '<span class="player-host-badge">👑</span>' : '';
                    
                    playerItem.innerHTML = `
                        <div class="player-info">
                            <div class="player-avatar">👤</div>
                            <div class="player-details">
                                <span class="player-nickname">${nickname}</span>
                                ${hostBadge}
                            </div>
                        </div>
                        ${kickButton}
                    `;
                    
                    playerListContainer.appendChild(playerItem);
                });
                
                lastHash = data.hash;
            })
            .catch(err => console.error("플레이어 목록 갱신 실패:", err));
    }

    setInterval(updatePlayerList, 1000); // ms
    </script>

    <!-- 링크 복사 -->
    <script>
    function copySessionLink() {
        const input = document.getElementById("session-link");
        const copyMessage = document.getElementById("copy-message");
        const copyBtn = document.querySelector(".copy-btn");
        
        input.select();
        input.setSelectionRange(0, 99999); // 모바일 대응

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                copyMessage.textContent = "✅ 클립보드에 복사되었습니다!";
                copyMessage.className = "copy-message success";
                copyBtn.innerHTML = '<span class="copy-btn-icon">✅</span><span class="copy-btn-text">복사됨</span>';
            } else {
                copyMessage.textContent = "❌ 복사에 실패했습니다.";
                copyMessage.className = "copy-message error";
            }
        } catch (err) {
            copyMessage.textContent = "❌ 이 브라우저는 복사를 지원하지 않습니다.";
            copyMessage.className = "copy-message error";
        }

        setTimeout(() => {
            copyMessage.textContent = "";
            copyMessage.className = "copy-message";
            copyBtn.innerHTML = '<span class="copy-btn-icon">📋</span><span class="copy-btn-text">복사</span>';
        }, 2000);
    }
    </script>
{% endblock %}