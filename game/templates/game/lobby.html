<!DOCTYPE html>
<html>
<head>
    <title>게임 로비</title>
    <style>
        #player-list td {
            padding: 0em 0.2em;
        }
        #player-list button {
            margin-right: 0.1em;
        }
        </style>
</head>
<body>
    <h1>게임 로비 - 세션 ID: {{ game_session.session_id }}</h1>
    <p><strong>플레이어:</strong> {{ player_nickname }}</p>

    <h2>현재 참여 중인 플레이어</h2>
    <table id="player-list">
        <tbody><tr><td colspan="2">플레이어 리스트 불러오는 중...</td></tr></tbody>
    </table >

    <h2>세션 공유 링크</h2>
    <p>
        <input type="text" id="session-link" value="{{ session_link }}" readonly style="width: 100px;">
        <button onclick="copySessionLink()">복사</button>
    </p>
    <p id="copy-message" style="color: green;"></p>


    <meta name="csrf-token" content="{{ csrf_token }}">
    <script>
    let lastHash = null;
    const playerNickname = "{{ player_nickname }}";
    const playerPin = "{{ player_pin }}";
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    function updatePlayerList() {
        const url = new URL("{% url 'get_players' game_session.session_id %}", window.location.origin);
        if (lastHash) {
            url.searchParams.append('hash', lastHash)
        };

        fetch(url)
            .then(response => {
                if (response.status === 204) { 
                    return; // 변경 없음, 아무것도 하지 않음
                }
                return response.json();
            })
            .then(data => {
                if (!data || !data.players) {
                    return;
                }
                
                const tableBody = document.getElementById("player-list");
                tableBody.innerHTML = '';

                data.players.forEach(function(nickname) {
                    const row = document.createElement("tr");
                    const removeCell = document.createElement("td");
                    if (playerNickname === data.host_nickname && nickname !== playerNickname) {
                        const form = document.createElement("form");
                        form.method = "post";
                        form.action = "{% url 'kick_player' game_session.session_id %}";

                        const csrfInput = document.createElement("input");
                        csrfInput.type = "hidden";
                        csrfInput.name = "csrfmiddlewaretoken";
                        csrfInput.value = csrfToken;

                        const targetInput = document.createElement("input");
                        targetInput.type = "hidden";
                        targetInput.name = "target_nickname";
                        targetInput.value = nickname;

                        const myInput = document.createElement("input");
                        myInput.type = "hidden";
                        myInput.name = "nickname";
                        myInput.value = playerNickname;
                        
                        const myInput2 = document.createElement("input");
                        myInput2.type = "hidden";
                        myInput2.name = "pin";
                        myInput2.value = playerPin;

                        const button = document.createElement("button");
                        button.type = "submit";
                        button.textContent = "❌";

                        form.appendChild(csrfInput);
                        form.appendChild(targetInput);
                        form.appendChild(myInput);
                        form.appendChild(myInput2);
                        form.appendChild(button);
                        removeCell.appendChild(form);
                    }

                    const nameCell = document.createElement("td");
                    nameCell.textContent = nickname;

                    row.append(removeCell, nameCell);
                    tableBody.appendChild(row);
                });
                lastHash = data.hash;
            })
            .catch(err => console.error("플레이어 목록 갱신 실패:", err));
    }

    setInterval(updatePlayerList, 1000); // ms

    
    function copySessionLink() {
        const input = document.getElementById("session-link");
        input.select();
        input.setSelectionRange(0, 99999); // 모바일 대응

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                document.getElementById("copy-message").textContent = "클립보드에 복사되었습니다!";
            } else {
                document.getElementById("copy-message").textContent = "복사에 실패했습니다.";
            }
        } catch (err) {
            document.getElementById("copy-message").textContent = "이 브라우저는 복사를 지원하지 않습니다.";
        }

        setTimeout(() => {
            document.getElementById("copy-message").textContent = "";
        }, 2000);
    }
    </script>


</body>
</html>
