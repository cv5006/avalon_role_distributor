{% extends 'game/includes/base.html' %}
{% block head_title %}ê²Œì„ ìƒì„±{% endblock %}
{% block page_title %}ê²Œì„ ìƒì„±{% endblock %}

{% block content %} 
    <div class="home-container">
        <div class="welcome-section">
            <div class="app-icon">ğŸ°</div>
            <h2 class="welcome-title">ì•„ë°œë¡ ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</h2>
            <p class="welcome-subtitle">ìµœê³ ì˜ ì „ëµ ê²Œì„ì„ ê²½í—˜í•˜ì„¸ìš”</p>
        </div>

        <form method="post" class="game-form">
            {% csrf_token %}
            
            <!-- ê²Œì„ ì˜µì…˜ ì„ íƒ -->
            <div class="options-section">
                <h3 class="section-title">ê²Œì„ ì˜µì…˜ ì„ íƒ</h3>
                <div class="options-grid">
                    <div class="option-card">
                        <input type="checkbox" id="enable_percival" name="enable_percival" value="true" class="option-checkbox">
                        <label for="enable_percival" class="option-label">
                            <div class="option-icon">ğŸ›¡ï¸</div>
                            <div class="option-content">
                                <h4>í¼ì‹œë²Œ ì¶”ê°€</h4>
                                <p>ë©€ë¦°ì„ ì§€í‚¤ëŠ” ì¶©ì§í•œ ìˆ˜í˜¸ì</p>
                            </div>
                            <div class="option-toggle"></div>
                        </label>
                    </div>
                </div>
            </div>
            <div class="role-selection-section">
                <input type="hidden" name="active_roles" id="active-roles-data">
                <input type="hidden" name="composite_roles" id="composite-roles-data">

                <div class="role-dnd-container" style="display: flex; flex-direction: column; gap: 20px; align-items: center; width: 100%; max-width: 400px; margin: 0 auto;">
                    <div class="role-list" id="inactive-cards" style="width: 100%; padding: 10px; border: 2px dashed #ccc; border-radius: 8px; min-height: 200px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <h4 style="grid-column: span 2;">ë¹„í™œì„± ì•…ì¸</h4>
                        <div class="role-card" data-role-id="morgana">ëª¨ë¥´ê°€ë‚˜</div>
                        <div class="role-card" data-role-id="oberon">ì˜¤ë² ë¡ </div>
                        <div class="role-card" data-role-id="mordred">ëª¨ë“œë ˆë“œ</div>
                    </div>

                    <div class="controls" style="display: flex; flex-direction: row; gap: 10px; justify-content: center;">
                        <button type="button" id="to-active">â–¼</button>
                        <button type="button" id="to-inactive">â–²</button>
                    </div>

                    <div class="role-list" id="active-cards" style="width: 100%; padding: 10px; border: 2px dashed #ccc; border-radius: 8px; min-height: 200px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <h4 style="grid-column: span 2;">í™œì„± ì•…ì¸</h4>
                        <div class="role-card" data-role-id="assassin">ì•”ì‚´ì</div>
                    </div>

                    <div class="combine-controls" style="display: flex; flex-direction: row; gap: 10px; margin-top: 10px;">
                        <button type="button" id="combine">ê²¸ì§</button>
                        <button type="button" id="split">ê²¸ì§ í•´ì œ</button>
                    </div>
                </div>
            </div>

            <!-- ê²½ê³  ë©”ì‹œì§€ ì˜ì—­ -->
            <div id="validation-message" class="validation-message" style="display: none; margin: 20px 0; padding: 15px; border-radius: 8px; background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404;">
                <div class="message-icon">âš ï¸</div>
                <div class="message-text"></div>
            </div>

            <!-- ë©”ì¸ ì•¡ì…˜ ë²„íŠ¼ -->
            <div class="main-action-section">
                <button type="submit" class="create-session-btn" id="create-btn">
                    <span class="btn-icon">ğŸš€</span>
                    <span class="btn-text">ì„¸ì…˜ ë§Œë“¤ê¸°</span>
                </button>
            </div>

            <!-- ê°œë°œìš© ì˜µì…˜  -->
            <div class="dev-options-section">
                <details class="dev-options-toggle">
                    <summary class="dev-options-summary">
                        <span class="dev-icon">âš™ï¸</span>
                        <span class="dev-text">ê°œë°œìš© ì„¤ì •</span>
                    </summary>
                    <div class="dev-options-content">
                        <div class="dev-option">
                            <input type="checkbox" id="enable_dummy" name="enable_dummy" value="true" class="dev-checkbox">
                            <label for="enable_dummy" class="dev-label">
                                <span class="dev-option-icon">ğŸ‘¥</span>
                                <span class="dev-option-text">ë”ë¯¸ ìœ ì € ì¶”ê°€</span>
                            </label>
                        </div>
                    </div>
                </details>
            </div>
        </form>
    </div>
{% endblock %}

{% block extra_body %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // ê¸ˆì§€ëœ ì¡°í•© ì •ë³´
        const forbiddenCombinations = [
            ['mordred', 'oberon'],
            ['oberon', 'mordred'],
            ['morgana', 'oberon'],
            ['oberon', 'morgana']
        ];
        
        function showValidationMessage(message) {
            const messageDiv = document.getElementById("validation-message");
            const messageText = messageDiv.querySelector(".message-text");
            messageText.textContent = message;
            messageDiv.style.display = "flex";
            messageDiv.style.alignItems = "center";
            messageDiv.style.gap = "10px";
        }
        
        function hideValidationMessage() {
            document.getElementById("validation-message").style.display = "none";
        }
        
        function validateConfiguration() {
            const activeCards = document.querySelectorAll("#active-cards .role-card");
            const roleGroups = [];
            let hasAssassin = false;

            // ì—­í•  ê·¸ë£¹ êµ¬ì„± ë° ì•”ì‚´ì ì²´í¬
            activeCards.forEach(card => {
                const rawId = card.dataset.roleId;
                
                if (card.dataset.combined === "true") {
                    const components = rawId.split('_');
                    roleGroups.push(components);
                    if (components.includes('assassin')) hasAssassin = true;
                } else {
                    roleGroups.push([rawId]);
                    if (rawId === 'assassin') hasAssassin = true;
                }
            });

            // 1. ì•”ì‚´ì í•„ìˆ˜ ì²´í¬
            if (!hasAssassin) {
                showValidationMessage("âš”ï¸ ì•”ì‚´ìëŠ” í•„ìˆ˜ ì—­í• ì…ë‹ˆë‹¤! í™œì„± ì•…ì¸ì— í¬í•¨ì‹œì¼œì£¼ì„¸ìš”.");
                return false;
            }

            // 2. 3ê°œ ì´ìƒ ê²¸ì§ ì²´í¬
            for (const group of roleGroups) {
                if (group.length >= 3) {
                    showValidationMessage("ğŸš« 3ê°œ ì´ìƒì˜ ì—­í• ì€ ê²¸ì§í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
                    return false;
                }
            }

            // 3. ê¸ˆì§€ëœ ì¡°í•© ì²´í¬
            for (const group of roleGroups) {
                if (group.length === 2) {
                    const [role1, role2] = group;
                    for (const forbidden of forbiddenCombinations) {
                        if ((forbidden[0] === role1 && forbidden[1] === role2) ||
                            (forbidden[0] === role2 && forbidden[1] === role1)) {
                            showValidationMessage(`ğŸš« ${role1}ê³¼(ì™€) ${role2}ëŠ” ê²¸ì§í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`);
                            return false;
                        }
                    }
                }
            }

            hideValidationMessage();
            return true;
        }

        function toggleSelection(card) {
            card.classList.toggle("selected");
            // ì„ íƒ ë³€ê²½ ì‹œ ê²€ì¦
            setTimeout(validateConfiguration, 100);
        }

        function moveSelected(sourceList, targetList) {
            const selected = sourceList.querySelectorAll(".role-card.selected");
            selected.forEach(card => {
                card.classList.remove("selected");
                targetList.appendChild(card);
            });
            // ì´ë™ í›„ ê²€ì¦
            validateConfiguration();
        }

        function combineSelected(list) {
            const selected = list.querySelectorAll(".role-card.selected");
            if (selected.length !== 2) {
                showValidationMessage("ğŸ”— ê²¸ì§í•˜ë ¤ë©´ ì •í™•íˆ 2ê°œì˜ ì—­í• ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
                return;
            }

            const names = Array.from(selected).map(c => c.innerText);
            const ids = Array.from(selected).map(c => c.dataset.roleId);
            
            // ê²¸ì§ ì „ ë¯¸ë¦¬ ê²€ì¦
            if (ids.length >= 3) {
                showValidationMessage("ğŸš« 3ê°œ ì´ìƒì˜ ì—­í• ì€ ê²¸ì§í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
                return;
            }

            for (const forbidden of forbiddenCombinations) {
                if ((forbidden[0] === ids[0] && forbidden[1] === ids[1]) ||
                    (forbidden[0] === ids[1] && forbidden[1] === ids[0])) {
                    showValidationMessage(`ğŸš« ${names[0]}ê³¼(ì™€) ${names[1]}ëŠ” ê²¸ì§í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`);
                    return;
                }
            }

            const combinedName = names.join(" + ");
            const combinedID = ids.join("_");

            const newCard = document.createElement("div");
            newCard.className = "role-card";
            newCard.textContent = combinedName;
            newCard.dataset.roleId = combinedID;
            newCard.dataset.combined = "true";

            newCard.addEventListener("click", () => toggleSelection(newCard));

            selected.forEach(c => c.remove());
            list.appendChild(newCard);
            
            // ê²¸ì§ í›„ ê²€ì¦
            validateConfiguration();
        }

        function splitSelected(list) {
            const selected = list.querySelectorAll(".role-card.selected");
            selected.forEach(card => {
                if (!card.dataset.combined) return;

                const parts = card.innerText.split(" + ");
                const ids = card.dataset.roleId.split("_");
                
                parts.forEach((name, index) => {
                    const partCard = document.createElement("div");
                    partCard.className = "role-card";
                    partCard.textContent = name;
                    partCard.dataset.roleId = ids[index] || name.replace(/\s+/g, '_');
                    partCard.addEventListener("click", () => toggleSelection(partCard));
                    list.appendChild(partCard);
                });
                card.remove();
            });
            
            // ë¶„ë¦¬ í›„ ê²€ì¦
            validateConfiguration();
        }

        // ëª¨ë“  ì—­í•  ì¹´ë“œì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ (ê¸°ì¡´ ì¹´ë“œ + ìƒˆë¡œ ì¶”ê°€ëœ ì¹´ë“œ)
        document.querySelectorAll(".role-card").forEach(card => {
            card.addEventListener("click", () => toggleSelection(card));
        });

        document.getElementById("to-active").addEventListener("click", () => {
            moveSelected(document.getElementById("inactive-cards"), document.getElementById("active-cards"));
        });

        document.getElementById("to-inactive").addEventListener("click", () => {
            moveSelected(document.getElementById("active-cards"), document.getElementById("inactive-cards"));
        });

        document.getElementById("combine").addEventListener("click", () => {
            combineSelected(document.getElementById("active-cards"));
        });

        document.getElementById("split").addEventListener("click", () => {
            splitSelected(document.getElementById("active-cards"));
        });

        // í¼ ì œì¶œ ì‹œ ìµœì¢… ê²€ì¦
        document.querySelector(".game-form").addEventListener("submit", (e) => {
            if (!validateConfiguration()) {
                e.preventDefault();
                return false;
            }
            
            const activeCards = document.querySelectorAll("#active-cards .role-card");
            const roleGroups = [];

            activeCards.forEach(card => {
                const rawId = card.dataset.roleId;

                if (card.dataset.combined === "true") {
                    const components = rawId.split('_');
                    roleGroups.push(components);
                } else {
                    roleGroups.push([rawId]);
                }
            });

            document.getElementById("active-roles-data").value = JSON.stringify(roleGroups);
        });

        // ì´ˆê¸° ê²€ì¦ ì‹¤í–‰
        validateConfiguration();
    });
</script>
{% endblock %}