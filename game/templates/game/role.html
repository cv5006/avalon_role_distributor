{% extends 'game/includes/base.html' %}
{% load role_extras %}
{% block head_title %}게임 시작{% endblock %}
{% block page_title %}게임 시작{% endblock %}

{% block content %} 
    <div class="role-container">
        <!-- 게임 정보 카드 -->
        <div class="game-info-card">
            <div class="info-header">
                <div class="info-icon">🏰</div>
                <h3 class="info-title">게임 정보</h3>
            </div>
            
            <div class="info-content">
                <div class="info-item">
                    <span class="info-label">세션 ID</span>
                    <span class="info-value session-id">{{ game_session.session_id }}</span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">게임 옵션</span>
                    <div class="info-options">
                        {% if game_session.option1 and game_session.option2 %}
                                                         <span class="option-badge percival">🛡️ 퍼시벌</span>
                             <span class="option-badge morgana">🦹‍♀️ 모르가나</span>
                         {% elif game_session.option1 %}
                             <span class="option-badge percival">🛡️ 퍼시벌</span>
                         {% elif game_session.option2 %}
                             <span class="option-badge morgana">🦹‍♀️ 모르가나</span>
                        {% else %}
                            <span class="option-badge none">🎯 기본 게임</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="info-item">
                    <span class="info-label">현재 플레이어</span>
                    <span class="info-value player-name">{{ player_nickname }}</span>
                </div>
                
                <div class="info-item composition-info">
                    <span class="info-label">게임 구성</span>
                    <div class="composition-summary">
                        <div class="team-composition good-team">
                            <span class="team-header">{{ "loyal_servant"|role_emoji }} 선인 {{ good_total }}명</span>
                            <span class="team-details">
                                ({% for role, count in good_composition.items %}{{ role }} {{ count }}명{% if not forloop.last %}, {% endif %}{% endfor %})
                            </span>
                        </div>
                        <div class="team-composition evil-team">
                            <span class="team-header">{{ "minion_of_mordred"|role_emoji }} 악인 {{ evil_total }}명</span>
                            <span class="team-details">
                                ({% for role, count in evil_composition.items %}{{ role }} {{ count }}명{% if not forloop.last %}, {% endif %}{% endfor %})
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 플레이어 목록 카드 -->
        <div class="players-card">
            <div class="players-header">
                <div class="players-icon">👥</div>
                <h3 class="players-title">참여 플레이어</h3>
                <div class="players-count">{{ players_in_session|length }}명</div>
            </div>
            
            <div class="players-content">
                <div class="player-grid">
                    {% for player_obj in players_in_session %}
                    <div class="player-item-compact">
                        <div class="player-avatar-small">👤</div>
                        <div class="player-nickname-compact">{{ player_obj.nickname }}</div>
                        {% if player_obj.nickname == game_session.host_nickname %}
                            <div class="player-host-badge-small">👑</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- 역할 정보 카드 -->
        <div class="role-card">
            <div class="role-header">
                <div class="role-header-icon">🎭</div>
                <h3 class="role-title">당신의 역할</h3>
            </div>
            
            <div class="role-content">
                <div class="role-image-container">
                    {% if player.role_images and player.role_images|length > 1 %}
                        <!-- 다중 역할 이미지 -->
                        <div class="multi-role-images">
                            {% for image in player.role_images %}
                                <img src="{{ image }}" alt="역할 {{ forloop.counter }}" class="role-image-small-role">
                            {% endfor %}
                        </div>
                    {% else %}
                        <!-- 단일 역할 이미지 -->
                        <img src="{% if player.role_images.0 %}{{ player.role_images.0 }}{% else %}/static/default_role.png{% endif %}" alt="{{ player.primary_role }}" class="role-image">
                    {% endif %}
                </div>
                
                <div class="role-intro">
                    {% if player.role_messages and player.role_messages|length > 0 %}
                        {% for message in player.role_messages %}
                            <h4 class="role-name-display">
                                {% with player.roles|get_role_at_index:forloop.counter0 as current_role %}
                                    {% if current_role %}
                                        {{ current_role|role_emoji }} {{ message.bold }}
                                    {% else %}
                                        {{ message.bold }}
                                    {% endif %}
                                {% endwith %}
                            </h4>
                        {% endfor %}
                    {% endif %}
                </div>
                
                <div class="role-description">
                    {% if player.role_messages and player.role_messages|length > 0 %}
                        {% for message in player.role_messages %}
                            <div class="role-detail-section">
                                {{ message.desc|linebreaksbr|safe }}
                                {% if message.ability %}
                                    <span class="target-players">{{ message.visible|safe }}</span>
                                {% endif %}
                                {% if not forloop.last %}<hr class="role-separator">{% endif %}
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 호스트 액션 카드 (호스트만 보임) -->
        {% if player_nickname == game_session.host_nickname %}
        <div class="host-actions-card danger">
            <div class="host-header">
                <div class="host-icon">🛑</div>
                <h3 class="host-title">게임 관리</h3>
                <div class="host-badge">호스트</div>
            </div>
            
            <div class="host-content">
                <p class="end-description">게임을 중단하고 싶으시면 아래 버튼을 눌러주세요</p>
                <form id="end-game-form" method="post" action="{% url 'end_game' game_session.session_id %}">
                    {% csrf_token %}
                    <input type="hidden" name="nickname" value="{{ player_nickname }}">
                    <input type="hidden" name="pin" value="{{ player_pin }}">
                    <button type="submit" class="end-game-btn" onclick="return confirm('정말로 게임을 종료하시겠습니까?');">
                        <span class="btn-icon">🛑</span>
                        <span class="btn-text">게임 종료</span>
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
{% endblock %}
